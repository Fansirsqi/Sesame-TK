name: Android CI

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予写入权限

    steps:
      - name: Set Timezone to Asia/Shanghai
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "Current time: $(date)"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "zulu"
          cache: gradle

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          gradle-version: wrapper

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 关键修改1：移除多风味构建，只构建单一Release版本
      - name: Build with Gradle
        run: ./gradlew assembleRelease -Pversion=${{ github.ref_name }}

      # 关键修改2：APK路径改为默认的release目录（无normal子目录）
      - name: Locate APKs and Set Outputs
        id: locate_apks
        run: |
          # 单一版本APK路径：app/build/outputs/apk/release/xxx.apk
          signed_apk=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          echo "signed_apk=$signed_apk" >> $GITHUB_OUTPUT

      # 关键修改3：简化复制逻辑（仅处理单一APK）
      - name: Copy APKs to staging for signing
        run: |
          mkdir -p app/build/outputs/apk/all
          cp "${{ steps.locate_apks.outputs.signed_apk }}" app/build/outputs/apk/all/

      - name: Sign APKs
        id: sign_apks
        uses: ilharp/sign-android-release@v2
        with:
          releaseDir: app/build/outputs/apk/all
          signingKey: ${{ secrets.ANDROID_SIGNING_KEY }}
          keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          buildToolsVersion: 36.0.0

      # 关键修改4：直接获取签名后的APK路径（无需区分风味）
      - name: Extract Signed APK Paths
        id: extract_apks
        run: |
          # 签名后的文件路径以冒号分隔，直接取第一个
          IFS=':' read -r -a files <<< "${{ steps.sign_apks.outputs.signedFiles }}"
          echo "signed_apk=${files[0]}" >> $GITHUB_OUTPUT

      # 上传单一APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: ${{ steps.extract_apks.outputs.signed_apk }}

      # 关键修改5：简化文件名和版本号提取逻辑（无风味标识）
      - name: Extract file names
        id: extract_info
        run: |
          signed_file=$(basename "${{ steps.extract_apks.outputs.signed_apk }}")
          # 提取版本号（以"-signed.apk"之前的部分作为版本）
          version=$(echo "$signed_file" | sed -E 's/.*-(.*)-signed\.apk/\1/')
          echo "signed_file=$signed_file" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Generate APKS Checksum
        run: |
          sha256sum ${{ steps.extract_apks.outputs.signed_apk }} > CHECKSUMS-Sesame-${{ steps.extract_info.outputs.version }}.${{ env.SHORT_SHA }}-signed.apk.sha256

      - name: Create Tag from Version
        if: startsWith(github.ref, 'refs/heads/main') && github.event_name == 'push'
        uses: actions/github-script@v6
        with:
          script: |
            const tagName = 'v${{ steps.extract_info.outputs.version }}';
            console.log(`Creating tag: ${tagName}`);
            
            // 创建轻量标签
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tagName}`,
              sha: context.sha
            });
            
      - name: Upload Assets to Source Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.extract_info.outputs.version }}
          files: ${{ steps.extract_apks.outputs.signed_apk }}
          tag_name: ${{ steps.extract_info.outputs.version}}
          draft: false
          append_body: true
          generate_release_notes: true
          body: |
            ## ✨What's Changed

            ${{ steps.commit_details.outputs.COMMIT_MESSAGE_BODY }}
            > ## 下载说明
              * 适用于`Android 8.0`及以上的系统

            > 倒卖必死全家
